<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeSYS</title>
    <script src="https://api.lucsoft.de/flatweb/beta/webgen"></script>
    <script src="https://api.lucsoft.de/flatweb/beta/jquery.js"></script>
    <script src="/lib/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Roboto:200,300,100" rel="stylesheet">
    <link rel="stylesheet" href="https://api.lucsoft.de/flatweb/beta/init.php">
    <theme><link rel="stylesheet" href="https://api.lucsoft.de/flatweb/beta/css/white.css"></theme>
</head>
    <body class="FlatWeb nochange">
        <span id='notifybox' class="notifybox">Reconnected</span>
        <article id="page" class="">
        </article>
        <script>
            var test,socket;
            var ele = {titlew: "titlew",cardlist:"cardlist", imagelist:"imagelist",linebreak:"linebreak",titles:"titles",searchbox:"searchbox",buttons:"buttons", loginwindow:"loginwindow",window:"window", imglist:"imglist",applist:"applist"};
            loadModule("lucsoft.database", () => {database.apiurl = "/";
            
                elementscount++;
                $("#page").append(`<cardlist id="${elementscount}" class="iconlist"></cardlist>`);
                $(`#${elementscount}`).addClass("max-width");
                $(`#${elementscount}`).addClass("grid_columns_1");
                
                var elementscountid = elementscount;
                elementscount++;
                $(`#${elementscountid}`).append(`<card id="${elementscount}"class="iconbox nohover"><img src="/imgs/homesys.png"></card>`);
                var card = elementscount;
                $(`#${card}`).addClass("blob");
                
                database.login("admin", filterCookie("loginpassword"), (e) => {
                    changeSpaceing(1, 1);
                    waitFor(300, () => {
                            changeSpaceing(1, 2);
                            addElement("loginwindow", {text: {password: "Password", button: "Login", text:"Login to HomeSYS"},
                                beforelogin: () => {
                                $('#loginerrormsg').css("color", "black");
                                $('#loginerrormsg').css("margin", "1.6rem");
                                $('#loginerrormsg').css("font-weight", "300");
                                $('#loginerrormsg').html("Anmeldung LÃ¤uft...");  
                                changeSpaceing(1, 2);
                            },afterlogin: (e) => {
                                removeLastElement();
                                removeLastElement();
                                hidee("#3");
                                $(`#${card}`).removeClass("blob");
                                changeSpaceing(1, 1);
                                $(`#${card}`).addClass("blobout");
                                waitFor(800,() => {
                                    loadHome();
                                    socket = io();
                                    socket.on('system', function(es) {
                                        if(es == "logged in") {
                                            triggerNotify("Logged in");
                                        }
                                        if(es == "trigger debug") {
                                            triggerNotify("This is a Debug Message");
                                        }
                                        console.log(es);    
                                    });
                                    socket.on('disconnect', () => {
                                        triggerNotify("Connection lost");
                                    });
                                    socket.on('reconnect', (attemptNumber) => {
                                        socket.emit("system", "login " + e);
                                        triggerNotify("Connection established");
                                    });
                                    socket.emit("system", "login " + e);
                                    document.cookie = "loginpassword=" + database.account.password;
                                    $('nav').css("opacity", "100");
                                });
                            },onError: () => {
                                $('#loginerrormsg').css("color", "red");
                                $('#loginerrormsg').css("margin", "1rem");
                                $('#loginerrormsg').css("font-weight", "600");                    
                                $('#loginerrormsg').html("Deine Anmeldedaten sind falsch");
                            }}, (e)=> { 
                                test=e;
                            });
                            newline();
                            newline();
                            newline();
                        });
                    },(e) => {
                        changeSpaceing(1, 1);
                        waitFor(1200, () => {
                            loadHome();
                            socket = io();
                            socket.on('system', function(es) {
                                if(es == "logged in") {
                                    triggerNotify("Logged in");
                                }
                                if(es == "trigger debug") {
                                    triggerNotify("This is a Debug Message");
                                }
                                console.log(es);    
                            });
                            socket.on('disconnect', () => {
                                triggerNotify("Connection lost");
                            });
                            socket.on('reconnect', (attemptNumber) => {
                                socket.emit("system", "login " + e);
                                triggerNotify("Connection established");
                            });
                            socket.emit("system", "login " + filterCookie("loginpassword"));
                            $('nav').css("opacity", "100");
                        });
                    });
            });
            var menu = `[
                    {
                        "title":"Home",
                        "fun":"loadHome();",
                        "style":"left"
                    },
                    {
                        "title":"Devices",
                        "fun":"loadDevices();"
                    },
                    {
                        "title":"Modules",
                        "fun":"loadModules()"
                    },
                    {
                        "title":"Settings",
                        "fun":"loadSettings()"
                    }
                ]`;
            function loadSettings() {
                $('article').remove();
                $('nav').remove();
                createNav(menu, "style_nobox");
                $('body').append('<article id="page" class="padding"></article>');
                addElement(ele.window, {
                    content: `<span class="text">
                        <splitView class="one nomargin">
                            <sidebar class="list">
                                <span class="item" onclick="loadSettingsDashboard()">Dashboard</span>
                                <span class="item" onclick="loadSettingsDevices()">Devices</span>
                                <span class="item" onclick="loadSettingsSystem()">System</span>
                                <span class="item" onclick="loadSettingsAbout()">About</span>
                            </sidebar>
                            <content style="padding: 1rem">
                            </content>
                        </splitView>
                    </span>`,
                    text: { title: "Settings" },
                    max_width: "90rem",
                    buttons: [ ]
                },
                () => { loadSettingsDashboard();
                    
                });
            }
            function loadSettingsDevices() {
                $("content").html('<span class="titleg">Connected Devices</span><div id="deviceitems"></div>');
                getDataAuth('http://' + window.location.hostname + '/device/connected',database.account.password, (e) => {
                    var objs = JSON.parse(e);
                    $("#deviceitems").html('<list class="style2 nomargin"></list>');
                    
                    objs.forEach(element => {                
                        $("list").append('<item>' + element.name +' (' + element.serialNumber + ')<span class="right"><button onclick="openUrl(`http://'+element.ip+'/restart`)">Restart</button><button onclick="openUrl(`http://'+element.ip+'/rgb?speed=5&repeat=2`)">Test</button></span></item>');                            
                    });              
               
                });
            }
            function openUrl(url) {
                getData(url, (e) => {});
            }
            var autoscroll= true;
            function updateLog(test = true) {
                if(!$("#log2").length) {
                    console.log("Disabled Interval: Log Refesh");
                    clearInterval(interval);
                    return;
                }
                getDataAuth('http://' + window.location.hostname + '/Mainframe/log',database.account.password, (e) => {
                    $('.log').html(e);
                    if (autoscroll){
                        if(test) {
                            scrollSmoothToBottom("log2");
                        } else {
                            scrollToBottom("log2");
                        }
                    }
                    
                });
            }
            var interval;
            function loadSettingsSystem() {
                try {
                    clearInterval(interval);
                } catch(e){}
                $("content").html('<span class="titleg">Modules</span><div id="moduleitems"></div>');
                $("#moduleitems").append('<center id="tshfuiosd"><br><button class="one"onclick="enableModules()">Enable Modules View</button><br><br></center>');
                
                $("content").append('<br>');
                $("content").append('<span class="titleg">Debugging</span><div id="debuggingitems"></div>');
                $("#debuggingitems").append('<center id="tshfuiosd"><br><button class="one"onclick="enableLog()">Enable Debugging</button><br><br></center>');
                
            }
            function enableModules() {
                getDataAuth('http://' + window.location.hostname + '/Mainframe/modules',database.account.password, (e) => {
                    var objs = JSON.parse(e);
                    $("#moduleitems").html('<list class="style2 nomargin"></list>');
                    objs.forEach(element => {                
                        $("list").append('<item>' + element.name+'<span class="right">' + ((element.disabled) ? "DISABLED": "ENABLED" )+'</span></item>');                                  
                    });              
                });
            }
            function enableLog() {
                $("#debuggingitems").html("");
                addElement(ele.buttons,{
                    big: false,
                    nocenter: true,
                    list:[
                        {text: "Restart", onclick: "getDataAuth('http://" + window.location.hostname + "/Mainframe/restart',database.account.password, (e) => {$('#log2').html('HomeSYS is Restarting...');});"},
                        {text: "Debug Message", onclick: "getDataAuth('http://" + window.location.hostname + "/Mainframe/debugmsg',database.account.password, (e) => {updateLog(false)});"},
                        {text: "Toggle Autoscroll", onclick: "autoscroll = !autoscroll"}
                    ]
                }, () => {}, "#debuggingitems");
                $("#debuggingitems").append('<div id="log2" class="log">Loading...</div>');
                $("#debuggingitems").append('<list class="two"><input class="custom" id="evalinput" type="text"><button class="one" style="width:auto;display:inline;"onclick="getDataAuth(\'http://homesys.local/Mainframe/eval?command=\'+ $(\'#evalinput\').val(),database.account.password, (e) => {$(\'#evalinput\').val(\'\')});">Run</button></list>');
                updateLog(false);
                interval = setInterval(() => {updateLog()}, 2000); 
            }
            function loadSettingsDashboard() {
                $("content").html("")
                addElement("cardlist",{
                    small: true,
                    grid_columns: 3,
                    cardtype: "lline",
                    effect: false,
                    cards:[
                        {title: "4", subtitle: "ACTIVE Devices"},
                        {title: "9", subtitle: "Connected Devices"},
                        {title: "Open", subtitle: "PROJECT REQUESTS"}
                    ]
                }, () => {}, "content");
            }
            function loadSettingsAbout() {
                $("content").html("")
                addElement(ele.titles, {
                    title: "Â© 2019 lucsoft",
                    subtitle: "Made with Love in Germany by lucsoft-DevTeam",
                    subtitleposx: "0rem"
                }, () => {},"content");
                addElement("cardlist",{
                    small: true,
                    grid_columns: 5,
                    cardtype: "lline",
                    max_width: false,
                    effect: false,
                    cards:[
                        {title: "lucsoft.de"},
                        {title: "WebGen"},
                        {title: "npm"},
                        {title: "nodejs"},
                        {title: "GitHub"},
                        {title: "express.js"},
                        {title: "hap-nodejs"},
                        {title: "https"},
                        {title: "request"}
                    ]
                }, () => {}, "content");
            }
            function loadDevices() {
                $('article').remove();
                $('nav').remove();
                createNav(menu, "style_nobox");
                $('body').append('<article id="page" class="padding"></article>');
                addElement(ele.buttons,{
                    big: true,
                    list:[
                        {text: "Turn Everything off", onclick: ""},
                        {text: "Turn Everything on", onclick: ""},
                        {text: "Turn on Schreibtisch", onclick: ""}
                    ]
                }, () => {});

                addLayout("connectedDevices");
                addElement("titles", {
                    title: "Connected Devices",
                    subtitle: "Here you can see all Devices"
                }, () => {},"#connectedDevices");
                addElement("cardlist",{
                    small: true,
                    grid_columns: "auto",
                    cards:[
                        {title: "Loading..."},
                        {title: "Loading..."},
                        {title: "Loading..."}
                    ]
                }, () => {},"#connectedDevices");
                getDataAuth('http://' + window.location.hostname + '/device/connected',database.account.password, (e) => {
                    var objs = JSON.parse(e); 
                    console.log(objs);
                });
                setInterval(() => {
                   
                }, 1000);
            }
            function loadModules() {
                $('article').remove();
                $('nav').remove();
                createNav(menu, "style_nobox");
                $('body').append('<article id="page" class="padding"></article>');
                addElement("titles", {
                    title: "The Marketplace for your HomeSYS",
                    subtitle: "Here you can install, update or remove Modules"
                }, () => {});
                addElement("cardlist",{
                    small: true,
                    grid_columns: "auto",
                    cards:[
                        {title: "Loading..."},
                        {title: "Loading..."},
                        {title: "Loading..."}
                    ]
                }, () => {});
                getDataAuth('http://' + window.location.hostname + '/Mainframe/store/trending',database.account.password, (e) => {
                    var objs = JSON.parse(e);
                    if(objs.authentication == "granted") {
                        removeLastElement();
                        var trendy = [];
                        var installed  = [];
                        objs.modules.forEach(modl => {
                            trendy.push({title: modl.name, subtitle: modl.id + " | " + modl.version, img: modl.icon == false ? '/imgs/noicon.png' : modl.icon,disabled: modl.disabled,button: installed.indexOf(modl.id) != -1 ? "Uninstall" : "Install"});
                        });
                        addElement(ele.applist,{
                            grid_columns: "auto",
                            max_width: true,
                            app:trendy
                        }, () => {});
                    } else {
                        $('#page').html("");
                        addElement("titlew", {
                            title: "403 Forbidden",
                            subtitle: "You dont have Permissions to Access the Store",
                            subtitleposx: "0"
                        }, () => {});
                    }
                    getDataAuth('http://' + window.location.hostname + '/Mainframe/modules',database.account.password, (e) => {
                        var json = JSON.parse(e);
                        var modules = [];
                        json.forEach(modl => {
                            if(modl['icon'] != undefined) {
                                modules.push({title: modl.name, subtitle: modl.id + " | " + modl.version, img: modl.icon == false ? '/imgs/noicon.png' : modl.icon,disabled: true,button: "Uninstall"});
                            } else {
                                modules.push({title: modl.name, subtitle: modl.name + " | " + "No Version" , img: '/imgs/noicon.png' ,button: "Uninstall"});
                            
                            }
                                
                        });
                        newline();
                        newline();
                        newline();
                        addElement("titles", {
                           title:"Active Modules"
                        }, () => {});
                        addElement(ele.applist,{
                            grid_columns: "auto",
                            max_width: true,
                            app:modules
                        }, () => {});     
                        newline();
                        newline();
                        newline();      
                    });
                });
                
               /* addElement("searchbox",{
                    searchtext:"Search for a Module",
                    index: [{name: ["lucsoft.DiscordClient","v0.1.2"],id:"lucsoft.DiscordClient",street:"2 Installations"}],
                    error: {
                        notfound: "Not Found"
                    }, onsearch: () => {
                        godown(false);
                    }, onclose:() => {
                        loadModules();
                    }
                },(e) => { e.input.focus();});
                newline();
               /* elementscount++;
                $("#page").append(`<cardlist id="${elementscount}" class="iconlist"></cardlist>`);
                $(`#${elementscount}`).addClass("max-width");
                $(`#${elementscount}`).addClass("grid_columns_auto");
                
                var elementscountid = elementscount;
                elementscount++;
                $(`#${elementscountid}`).append(`<card id="${elementscount}"class="iconcard">
                    <img src="https://data.lucsoft.de/uploads/HomeSYS_compressd2.png">
                    <div>
                    <span class="title">HomeKit / Siri</span>
                    <span class="subtitle">Using HAP-NodeJS, HAPWrapper</span>
                    <center><button class="one">Install and Reload</button></center>
                    </div>
                </card>`);
                elementscount++;
                $(`#${elementscountid}`).append(`<card id="${elementscount}"class="iconcard">
                    <img src="https://data.lucsoft.de/uploads/HomeSYS_compressd2.png">
                    <div>
                    <span class="title">lucsoft.webServer</span>
                    <span class="subtitle">Required Module</span>
                    <button class="one disabled">You can't remove it...</button>
                    </div>
                </card>`);
                $(`#${elementscountid}`).append(`<card id="${elementscount}"class="iconcard">
                    <img src="https://data.lucsoft.de/uploads/HomeSYS_compressd2.png">
                    <div>
                    <span class="title">lucsoft.Mainframe</span>
                    <span class="subtitle">Required Module (v0.2.0)</span>
                    <button class="one disabled">You can't remove it...</button>
                    </div>
                </card>`);
                 */
            }
            function loadHome() {
                $('article').remove();
                $('nav').remove();
                createNav(menu, "style_nobox");
                $('body').append('<article id="page" class="padding"></article>');
                $('#page').append('<span class="note" style="display: block;">No Problems ðŸ˜„! Checking for Updates...</span>');
                $('#page').append('<splitView class="m"><content></content><sidebar></sidebar></splitView>');
                addElement("cardlist",{
                    small: true,
                    grid_columns: 2,
                    cardtype: "lline",
                    max_width: true,
                    effect: false,
                    cards:[
                        {title: "4", subtitle: "ACTIVE Devices"},
                        {title: "9", subtitle: "Connected Devices"},
                        {title: "Alpha", subtitle: "Version"}
                    ]
                }, () => {}, "content");
                addElement("imglist", {
                    max_width: true,
                    grid_columns: 1,
                    imgs: [
                        {
                            nohover: true,
                            url: "https://images.pexels.com/photos/1072851/pexels-photo-1072851.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940",
                            title: "Testing HomeSYS WebUI",
                            subtitle: "Testing testing testing<br>"
                        }
                    ]
                }, () => {}, "sidebar");
            }
        </script>
    </body>
</html>